---
title: "Logistic Regression Classification with Interactions"
author: "Mervin M Fansler"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document: 
    code_folding: show
    toc: true
    toc_float: true
---

# Purpose

Here we attempt using covariates and their interactions to classify genes into 
localization groups.

# Initialization

## Libraries
```{r libs, message=FALSE, warning=FALSE}
library(magrittr)
library(tidyverse)
library(ggtern)
library(ggrepel)
library(broom)
library(caret)
library(nnet)
library(readxl)
library(writexl)
```

## Parameters
```{r set_params}
set.seed(20220607)
N_STEPS=500

RDS_IN="data/df_tiger_clean.Rds"

LOC_COLORS=c("ER"="#4B74A6", "TG"="#E4E4CA", "CY"="#949494", "DF"="#CCCCCC")
LOC_COLORS_DARK=c("ER"="#4B74A6", "TG"="#C9C497", "CY"="#949494", "DF"="#CCCCCC")

COVARIATES=c(
    # "Leb_HuR_CLIP", 
    "Muk_HuR_CLIP", 
    # "CPE_annoUTR", 
    # "CCCCCC_3UTR_num",
    "Pumilio_3UTR_num", 
    # "PUM2_CLIP", 
    # "KHSRP_CLIP", 
    # "CPSF6_CLIP", 
    "TIS11B_CLIP", 
    "TIA1_L1_CLIP", 
    # "PTBP1_CLIP", 
    # "HNRNPC_CLIP",
    # "CELF2_CLIP", 
    # "HNRNPM_CLIP", 
    "HNRNPD_CLIP", 
    # "Zhang_RBM15_RIP",
    # "LIN28B_CLIP", 
    "IGF2BP3_CLIP", 
    # "TARDBP_CLIP", 
    # "TAF15_CLIP",
    "FUS_CLIP", 
    "METAP2_CLIP", 
    # "DDX6_CLIP", 
    # "EIF4A3_CLIP",
    "LARP4B_exon_CLIP", 
    # "hnRNPK_CLIP", 
    # "GEMIN5_CLIP", 
    # "CSTF2T_CLIP",
    # "DDX24_CLIP", 
    "PCBP2_CLIP", 
    "PUM_RIP12",
    "Anno_3UTR_length")
```

# Data
## Loading
```{r load_data, message=FALSE}
df_tiger <- readRDS(RDS_IN)
```

## Preprocessing
### Subset
```{r prepare_data}
df_data <- select(df_tiger, category, all_of(COVARIATES))
```

### Imputing
```{r data_impute}
df_imputed <- df_data %>%
    mutate_at("Anno_3UTR_length", ~ ifelse(is.na(.x), median(.x, na.rm=TRUE), .x)) %>%
    mutate_at(-1, ~ ifelse(is.na(.x), 0, .x))
```

### Data Normalizing
```{r data_normalize}
df_scaled <- mutate_at(df_imputed, -1, ~ scale(sqrt(.x))[,1])
```

### Splitting
```{r data_split}
idx_train <- createDataPartition(df_scaled$category, p=0.8, list=FALSE)

df_train <- df_scaled[idx_train,]
df_test  <- df_scaled[-idx_train,]

full_join(count(df_train, category, name="n_train"),
          count(df_test, category, name="n_test"),
          by="category") %>%
    knitr::kable()
```

# Analysis
## Logistic Regression Model
### Fit
```{r fit_model}
model <- multinom(category ~ .*., data=df_train, maxit=1000, MaxNWts=10000)
AIC(model)
tidy(model) %>% 
    arrange(p.value) %>%
    knitr::kable()
```

### Export
```{r export_fit} 
outfile <- sprintf("tbl/%s-model-fit-lr-interact-select.xlsx", format(Sys.time(), '%Y%m%d'))
tidy(model) %>%
    arrange(p.value) %>%
    write_xlsx(outfile)
```

### Model Accuracy
```{r prediction_accuracy}
mean(predict(model, df_test) == df_test$category)
```

### Coefficients
#### All
```{r plot_coefficients, fig.width=6, fig.height=16}
tidy(model) %>%
    mutate(term=fct_reorder(term, abs(estimate), max)) %>%
    filter(term != "(Intercept)") %>% 
    ggplot(aes(y=term, x=estimate, fill=y.level)) +
    geom_vline(xintercept=0) +
    geom_bar(stat='identity', position='dodge', color='black', size=0.1, width=0.9) +
    scale_fill_manual(values=LOC_COLORS) +
    labs(x="Coefficient", y=NULL, fill="Category") +
    theme_light()
```

#### Signficant
```{r plot_coefs_sig, fig.width=6, fig.height=6}
tidy(model) %>%
    mutate(term=fct_reorder(term, abs(estimate), max)) %>%
    filter(term != "(Intercept)") %>% 
    group_by(term) %>%
    mutate(has_sig=any(p.value < 0.05 & abs(estimate) > 0.2)) %>%
    ungroup() %>%
    filter(has_sig) %>%
    ggplot(aes(y=term, x=estimate, fill=y.level)) +
    geom_vline(xintercept=0) +
    geom_bar(stat='identity', position='dodge', color='black', size=0.1, width=0.9, ) +
    scale_fill_manual(values=LOC_COLORS) +
    labs(x="Coefficient", y=NULL, fill="Category") +
    theme_light()

ggsave("img/lr-interact-coefs-sig.pdf", width=6, height=6, dpi=300)
```

### Coefficient Points
```{r}
MIN_PVAL=0.1
MIN_STAT=0
df_coefs <- tidy(model) %>%
    filter(term != "(Intercept)") %>%
    pivot_wider(term, names_from=y.level, values_from=-c(1,2))
```

```{r fig.width=6, fig.height=6}
XLIMS=c(-2,2)
YLIMS=c(-2,2)

df_er_sig <- df_coefs %>%
    filter((p.value_ER < MIN_PVAL & statistic_ER > MIN_STAT) | 
               (p.value_TG < MIN_PVAL & statistic_TG > MIN_STAT) | 
               (p.value_CY < MIN_PVAL & statistic_CY > MIN_STAT)) %>%
    filter(!str_detect(term, ":"))

df_er_sig %>%
    ggplot(aes(x=estimate_TG, y=estimate_ER)) +
    geom_hline(yintercept=0, linetype='dashed') +
    geom_vline(xintercept=0, linetype='dashed') +
    geom_errorbar(aes(xmin=estimate_TG-std.error_TG, xmax=estimate_TG+std.error_TG),
                  color='lightgrey') +
    geom_errorbar(aes(ymin=estimate_ER-std.error_ER, ymax=estimate_ER+std.error_ER),
                  color='lightgrey') +
    geom_point() +
    geom_text_repel(aes(label=term), point.padding=0.5, box.padding=2, max.overlaps=100) +
    coord_cartesian(xlim=XLIMS, ylim=YLIMS) +
    labs(x="TG Coefficient", y="ER Coefficient") +
    theme_bw()

ggsave("img/lr-interact-sig-coefs-tg-er.pdf", width=6, height=6, dpi=300)

df_er_sig %>%
    ggplot(aes(x=estimate_CY, y=estimate_ER)) +
    geom_hline(yintercept=0, linetype='dashed') +
    geom_vline(xintercept=0, linetype='dashed') +
    geom_errorbar(aes(xmin=estimate_CY-std.error_CY, xmax=estimate_CY+std.error_CY),
                  color='lightgrey') +
    geom_errorbar(aes(ymin=estimate_ER-std.error_ER, ymax=estimate_ER+std.error_ER),
                  color='lightgrey') +
    geom_point() +
    geom_text_repel(aes(label=term), point.padding=0.5, box.padding=2, max.overlaps=100) +
    coord_cartesian(xlim=XLIMS, ylim=YLIMS) +
    labs(x="CY Coefficient", y="ER Coefficient") +
    theme_bw()

ggsave("img/lr-interact-sig-coefs-cy-er.pdf", width=6, height=6, dpi=300)

df_er_sig %>%
    ggplot(aes(x=estimate_TG, y=estimate_CY)) +
    geom_hline(yintercept=0, linetype='dashed') +
    geom_vline(xintercept=0, linetype='dashed') +
    geom_errorbar(aes(xmin=estimate_TG-std.error_TG, xmax=estimate_TG+std.error_TG),
                  color='lightgrey') +
    geom_errorbar(aes(ymin=estimate_CY-std.error_CY, ymax=estimate_CY+std.error_CY),
                  color='lightgrey') +
    geom_point() +
    geom_text_repel(aes(label=term), point.padding=0.5, box.padding=2, max.overlaps=100) +
    coord_cartesian(xlim=XLIMS, ylim=YLIMS) +
    labs(x="TG Coefficient", y="CY Coefficient") +
    theme_bw()

ggsave("img/lr-interact-sig-coefs-tg-cy.pdf", width=6, height=6, dpi=300)
```

### Coefficient Pairs
#### TIAL1, TIS11B
```{r coefs_tia_tis, fig.width=5, fig.height=4}
df_train %>% 
    summarize(across(everything(), mean)) %>% 
    slice(rep(1, N_STEPS)) %>%
    mutate(TIA1_L1_CLIP=seq(-10, 10, length.out=N_STEPS)) %>%
    slice(rep(1:N_STEPS, times=N_STEPS)) %>%
    mutate(TIS11B_CLIP=rep(seq(-10,10, length.out=N_STEPS), each=N_STEPS)) %>%
    mutate(category=predict(object=model, .)) %>%
    ggplot(aes(x=TIA1_L1_CLIP, y=TIS11B_CLIP, fill=category)) +
    geom_tile(linejoin="bevel") +
    scale_fill_manual(values=LOC_COLORS) +
    theme_bw()

ggsave("img/lr-interact-pairs-tial1-tis11b.pdf", width=5, height=4, dpi=300)
```

#### Pumilio Num, TIS11B
```{r coefs_pum_tis, fig.width=5, fig.height=4}
df_train %>% 
    summarize(across(everything(), mean)) %>% 
    slice(rep(1, N_STEPS)) %>%
    mutate(Pumilio_3UTR_num=seq(-10, 10, length.out=N_STEPS)) %>%
    slice(rep(1:N_STEPS, times=N_STEPS)) %>%
    mutate(TIS11B_CLIP=rep(seq(-10,10, length.out=N_STEPS), each=N_STEPS)) %>%
    mutate(category=predict(object=model, .)) %>%
    ggplot(aes(x=Pumilio_3UTR_num, y=TIS11B_CLIP, fill=category)) +
    geom_tile(linejoin="bevel") +
    scale_fill_manual(values=LOC_COLORS) +
    theme_bw()

ggsave("img/lr-interact-pairs-pumnum-tis11b.pdf", width=5, height=4, dpi=300)
```

#### Pumilio Num, TIAL1
```{r coefs_pum_tia, fig.width=5, fig.height=4}
df_train %>% 
    summarize(across(everything(), mean)) %>% 
    slice(rep(1, N_STEPS)) %>%
    mutate(Pumilio_3UTR_num=seq(-10, 10, length.out=N_STEPS)) %>%
    slice(rep(1:N_STEPS, times=N_STEPS)) %>%
    mutate(TIA1_L1_CLIP=rep(seq(-10,10, length.out=N_STEPS), each=N_STEPS)) %>%
    mutate(category=predict(object=model, .)) %>%
    ggplot(aes(x=Pumilio_3UTR_num, y=TIA1_L1_CLIP, fill=category)) +
    geom_tile(linejoin="bevel") +
    scale_fill_manual(values=LOC_COLORS) +
    theme_bw()

ggsave("img/lr-interact-pairs-pumnum-tial1.pdf", width=5, height=4, dpi=300)
```

#### HuR, TIS11B
```{r coefs_hur_tis, fig.width=5, fig.height=4}
df_train %>% 
    summarize(across(everything(), mean)) %>% 
    slice(rep(1, N_STEPS)) %>%
    mutate(Muk_HuR_CLIP=seq(-10, 10, length.out=N_STEPS)) %>%
    slice(rep(1:N_STEPS, times=N_STEPS)) %>%
    mutate(TIS11B_CLIP=rep(seq(-10,10, length.out=N_STEPS), each=N_STEPS)) %>%
    mutate(category=predict(object=model, .)) %>%
    ggplot(aes(x=Muk_HuR_CLIP, y=TIS11B_CLIP, fill=category)) +
    geom_tile(linejoin="bevel") +
    scale_fill_manual(values=LOC_COLORS) +
    theme_bw()

ggsave("img/lr-interact-pairs-hur-tis11b.pdf", width=5, height=4, dpi=300)
```

#### LARP4B, TIS11B
```{r coefs_larp4b_tis, fig.width=5, fig.height=4}
df_train %>% 
    summarize(across(everything(), mean)) %>% 
    slice(rep(1, N_STEPS)) %>%
    mutate(LARP4B_exon_CLIP=seq(-10, 10, length.out=N_STEPS)) %>%
    slice(rep(1:N_STEPS, times=N_STEPS)) %>%
    mutate(TIS11B_CLIP=rep(seq(-10,10, length.out=N_STEPS), each=N_STEPS)) %>%
    mutate(category=predict(object=model, .)) %>%
    ggplot(aes(x=LARP4B_exon_CLIP, y=TIS11B_CLIP, fill=category)) +
    geom_tile(linejoin="bevel") +
    scale_fill_manual(values=LOC_COLORS) +
    theme_bw()

ggsave("img/lr-interact-pairs-larp4b-tis11b.pdf", width=5, height=4, dpi=300)
```

#### Pum1/2 RIP, TIS11B
```{r coefs_pum12_tis, fig.width=5, fig.height=4}
df_train %>% 
    summarize(across(everything(), mean)) %>% 
    slice(rep(1, N_STEPS)) %>%
    mutate(PUM_RIP12=seq(-10, 10, length.out=N_STEPS)) %>%
    slice(rep(1:N_STEPS, times=N_STEPS)) %>%
    mutate(TIS11B_CLIP=rep(seq(-10,10, length.out=N_STEPS), each=N_STEPS)) %>%
    mutate(category=predict(object=model, .)) %>%
    ggplot(aes(x=PUM_RIP12, y=TIS11B_CLIP, fill=category)) +
    geom_tile(linejoin="bevel") +
    scale_fill_manual(values=LOC_COLORS) +
    theme_bw()

ggsave("img/lr-interact-pairs-pum12rip-tis11b.pdf", width=5, height=4, dpi=300)
```

#### Pum1/2 RIP, TIAL1
```{r coefs_pum12_tial1, fig.width=5, fig.height=4}
df_train %>% 
    summarize(across(everything(), mean)) %>% 
    slice(rep(1, N_STEPS)) %>%
    mutate(PUM_RIP12=seq(-10, 10, length.out=N_STEPS)) %>%
    slice(rep(1:N_STEPS, times=N_STEPS)) %>%
    mutate(TIA1_L1_CLIP=rep(seq(-10,10, length.out=N_STEPS), each=N_STEPS)) %>%
    mutate(category=predict(object=model, .)) %>%
    ggplot(aes(x=PUM_RIP12, y=TIA1_L1_CLIP, fill=category)) +
    geom_tile(linejoin="bevel") +
    scale_fill_manual(values=LOC_COLORS) +
    theme_bw()

ggsave("img/lr-interact-pairs-pum12rip-tial1.pdf", width=5, height=4, dpi=300)
```


#### Pum1/2 RIP, HuR
```{r coefs_pum12_hur, fig.width=5, fig.height=4}
df_train %>% 
    summarize(across(everything(), mean)) %>% 
    slice(rep(1, N_STEPS)) %>%
    mutate(PUM_RIP12=seq(-10, 10, length.out=N_STEPS)) %>%
    slice(rep(1:N_STEPS, times=N_STEPS)) %>%
    mutate(Muk_HuR_CLIP=rep(seq(-10,10, length.out=N_STEPS), each=N_STEPS)) %>%
    mutate(category=predict(object=model, .)) %>%
    ggplot(aes(x=PUM_RIP12, y=Muk_HuR_CLIP, fill=category)) +
    geom_tile(linejoin="bevel") +
    scale_fill_manual(values=LOC_COLORS) +
    theme_bw()

ggsave("img/lr-interact-pairs-pum12rip-hur.pdf", width=5, height=4, dpi=300)
```


#### Pum Num, FUS
```{r coefs_pumnum_fus, fig.width=5, fig.height=4}
df_train %>% 
    summarize(across(everything(), mean)) %>% 
    slice(rep(1, N_STEPS)) %>%
    mutate(Pumilio_3UTR_num=seq(-10, 10, length.out=N_STEPS)) %>%
    slice(rep(1:N_STEPS, times=N_STEPS)) %>%
    mutate(FUS_CLIP=rep(seq(-10,10, length.out=N_STEPS), each=N_STEPS)) %>%
    mutate(category=predict(object=model, .)) %>%
    ggplot(aes(x=Pumilio_3UTR_num, y=FUS_CLIP, fill=category)) +
    geom_tile(linejoin="bevel") +
    scale_fill_manual(values=LOC_COLORS) +
    theme_bw()

ggsave("img/lr-interact-pairs-pumnum-fus.pdf", width=5, height=4, dpi=300)
```


# Plot Predicted
## Ternary
```{r plot_predicted_tern, fig.width=5, fig.height=5, warning=FALSE, message=FALSE}
df_train %>%
    mutate(predicted=predict(model, .)) %>%
    cbind(df_tiger[idx_train, c("npco_er", "npco_cy", "npco_tg")]) %>%
    filter(category != "DF") %>%
    ggtern(aes(x=npco_er, y=npco_cy, z=npco_tg, color=predicted)) +
    geom_density_tern(size=0.5) +
    geom_point(size=0.1, alpha=0.3) +
    geom_Lline(Lintercept=0.4, linetype='dashed') + 
    geom_Rline(Rintercept=0.4, linetype='dashed') + 
    geom_Tline(Tintercept=0.4, linetype='dashed') +
    scale_color_manual(values=LOC_COLORS_DARK) +
    labs(x="ER", y="CY", z="TG", title="Training Set") +
    guides(color="none") +
    theme_bw()

ggsave("img/lr-interact-predict-train.pdf", width=5, height=5, dpi=300)

df_test %>%
    mutate(predicted=predict(model, .)) %>%
    cbind(df_tiger[-idx_train, c("npco_er", "npco_cy", "npco_tg")]) %>%
    filter(category != "DF") %>%
    ggtern(aes(x=npco_er, y=npco_cy, z=npco_tg, color=predicted)) +
    geom_density_tern(size=0.5) +
    geom_point(size=0.1, alpha=0.3) +
    geom_Lline(Lintercept=0.4, linetype='dashed') + 
    geom_Rline(Rintercept=0.4, linetype='dashed') + 
    geom_Tline(Tintercept=0.4, linetype='dashed') +
    scale_color_manual(values=LOC_COLORS_DARK) +
    labs(x="ER", y="CY", z="TG", title="Test Set") +
    guides(color="none") +
    theme_bw()

ggsave("img/lr-interact-predict-test.pdf", width=5, height=5, dpi=300)
```

## Confusion Matrix
```{r plot_predicted_confusion, fig.width=5, fig.height=4}
df_train %>%
    mutate(predicted=predict(model, .)) %>%
    count(category, predicted) %>% 
    ggplot(aes(category, predicted, fill=n)) +
    geom_tile() + geom_text(aes(label=n)) +
    scale_fill_gradient(low="white") +
    labs(title="Training Set", x="True Category", y="Predicted Category") +
    theme_light()

df_test %>%
    mutate(predicted=predict(model, .)) %>%
    count(category, predicted) %>% 
    ggplot(aes(category, predicted, fill=n)) +
    geom_tile() + geom_text(aes(label=n)) +
    scale_fill_gradient(low="white") +
    labs(title="Test Set", x="True Category", y="Predicted Category") +
    theme_light()
```


---

# Runtime Details
## Session Info
```{r sesh_info, echo=FALSE}
sessionInfo()
```

## Conda Environment
```{bash comment="", echo=FALSE}
if ! command -v conda &> /dev/null
then
  echo "Conda not detected."
elif [ -z "${CONDA_PREFIX}" ]
then
  echo "No active Conda environment."
else
  echo "## Conda Environment YAML"
  conda env export
fi
```
